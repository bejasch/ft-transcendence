# ft-transcendence - a pong web app

> A pong app with a heap of add-on features

- Live demo: [https://ft-transcendence.app](https://ft-transcendence.app)

## Build and Run

- Ensure `docker` and `docker compose` are working
- Run `cp .env.example .env`
- Adjust secrets in `.env`, possibly also in `config.env` if you have port issues
- Run `make` or `make prod`

## Advanced/Configuration

- [administrative commands regarding app management]
- [basic steps for configuration]
- Refer to the [Wiki](https://github.com/cubernetes/ft-transcendence/wiki) for more documentation

## Demo

- [a gif showcasing the main feature (pong)]
- [a gif showcasing the additional features (chat, accounts, etc.)]
- [opt: alt text: a gif showcasing the administrative features]

## Core Features

- Interactive webapp to play 3D pong - Front-End (John) && Back-End (Ben & Darren)
- Account management (TBD)
- Join matches via the a CLI client (or maybe [SSH](https://github.com/charmbracelet/wish), let's see) (TBD)
- Overkill security measures (ModSecurity, HashiCorp Vault, 2FA, JWT) (Timo)
- AI opponent (TBD)
- Some accessibility features (TBD)
- Log management and observability (ELK + Grafana) (Sonia)
- Game statistics also on Blockchain (John)

## Debugging / Development

### Websockets

- Use `wscat` to connect to the websocket server via Caddy:
    - `wscat -c ws://localhost:8080/ws`
    - `wscat -c localhost:8080/ws`
    - `wscat -nc wss://localhost:8443/ws`
- Or connect directly via the backend, by patching `compose.yaml`

    ```diff

        backend:
    +       ports:
    +           - "3000:${BACKEND_PORT:3000}"
            build:
                context: "./backend/"
    ```

    - `wscat -c localhost:3000/ws` (no wss)

### Coraza Web Application Firewall (WAF)

- Checking it it's enabled
    - `curl -vk https://localhost:8443/?exec=/bin/bash` should return `403 Forbidden`
- Disabling it
    ```diff
        handle {
    -       import waf
            root * /srv
            file_server
        }
        handle_path /api/* {
    -       import waf
            reverse_proxy http://backend:{$BACKEND_PORT:3000}
        }
    ```

### Makefile

- When running make (dev), arguments can be added to pass on additional flags for docker compose up. For instance `make dev ARGS="--no-attach caddy"` will silence any logs registered by the Caddy container, note that to silence more the flag needs to be repeated, i.e. `make dev ARGS="--no-attach caddy --no-attach backend"`. Similarly, you can also use `ARGS="--attach caddy"` for inclusive logging.

### API endpoint

- Check `/api/docs` for a list of backend endpoints auto-generated by swagger UI.

### Vault

#### General overview

All services that need secrets depend on the Vault service to start up and pass
the healthcheck. Vault injects a Vault token to each of those services via a
shared file (bind mount). Once the service has the token, it can make `GET` requests
to `http://vault:8200/v1/secret/$SERVICE_NAME` and extract the secrets from the
JSON response (`.data.data`). A token can only be used as many times as there
are secrets for a particular service (if the `backend` service only has the
`JWT_SECRET` secret, then it can make only a single `GET` request, after which the
token is invalidated). If not all secrets are read, it's each service is advised
to override/truncate the file to prevent unwanted access from the host system.

#### How Vault initially starts up

When Vault is started for the first time, the `vault` volume mounted at `/vault/file`
will be empty. The entrypoint recognizes that and starts the initialization process,
where it will start (`vault server`) and initialize (`vault operator init`) Vault.
Then it will extract the **unseal keys** and the **root token** from the stdout.
It uses the unseal keys to unseal Vault and then the root token to create
the policies and tokens for all the services. After that, if the environment
variables `SAVE_UNSEAL_KEYS` or `SAVE_ROOT_TOKEN` are `1`, it will save the
respective secret in another volume called `vault_secret` at `/vault/secret/`.
This is the default, but for security they should be `0` and you should look
at the service logs and make note of those secrets. However, as of now, there
is no way to provide those secrets to Vault at startup. One possible way would
be to have a helper script that then talks via HTTP (or raw TCP) to the Vault
container, but yeah, PRs welcome :)

#### How Vault starts again

When the `/vault/file` directory is not empty, it must have been initialized before,
so it goes through a simpler flow where it just starts Vault, reads the unseal
keys and root token from `/vault/secret/`, unseals Vault, revokes all
tokens, creates new tokens, and injects those to the services as described above.

#### I want to add a new service or more secrets for a given service

Secrets are specified in `./vault/env.json`. Since most secrets can be automatically
generated, you can specify them using a custom double brace syntax (sometimes called
mustace syntax): `{{alnum:64}}`. Make sure the system you're running on has [enough
entropy](https://superuser.com/questions/944510/why-am-i-constantly-running-out-of-entropy).
Each secret is a string associated to a service, and each service is a subkey of
the root json object. Secrets that don't follow this exact structure will be
skipped and a warning will be raised.
Secrets that cannot be generated at runtime should not be specified using the template
syntax, specifically, they must not match this PCRE regex: `\{\{\w+:\d+\}\}`. In
case they only match `\{\{.*\}\}`, a warning will be raised, but the string will
be left unmodified. Note that non-secret data can be specified here as well for
uniformity.

**Important**: In case you add secrets that cannot be generated (like OAuth secrets),
it is highly advised to add `env.json` to `.gitignore`. In case you change the
structure of `env.json`, remove it from `.gitignore`, run `git add -p` (only
add the non-sensitive parts), commit it, and then add it back to `.gitignore`.

#### Increasing the LOGLEVEL

The `LOGLEVEL` environment variable may be set to `error`, `warn`, `info`, `debug`
Note that for loglevels `info` and `debug`, the unseal keys and the root token
will be printed to stdout, so they will show up in the service logs. You want this
if you need to manually save those secrets. However, you can also remove one
line in `./vault/endpoint.sh` to not print those secrets (then you should set
`SAVE_UNSEAL_KEYS` and `SAVE_ROOT_TOKEN` to `1`):

```diff
 	else
 		info "Vault storage backend is empty. Initializing vault"
 
 		start_server_in_bg
 		wait_and_extract_secrets
-		show_secrets
 		maybe_save_secrets
 		export_environment
 		ensure_unsealed
```

#### I need the secret for a particular service, how do I get it?

If `SAVE_ROOT_TOKEN` was `1` and the vault is unsealed and running, you can retrieve
all secrets for a given `$SERIVCE` using the following command from the docker host:

```console
docker exec vault sh -c '
    SERVICE=backend
    wget --header="X-Vault-Token: $(cat /vault/secret/root_token)" \
        --quiet \
        --output-document=- \
        "$(cat /tmp/vault_addr)"/v1/secret/data/$SERVICE | 
    jq --raw-output --color-output .data.data'
```

#### The vault architecture is weird, why would you do it this way?

It is weird, but this project's requirements (more or less) force us to
automate it to such a high degree that it almost doesn't make sense anymore.
Vault is wayyyy overkill for this project anyways.
Please read the first section of this [PR](https://github.com/cubernetes/ft-transcendence/pull/50)
to understand why some questionable decisions had to be made.

## Project Modules Tally

|               |        Module         |                       Notes                       | Point |
| :-----------: | :-------------------: | :-----------------------------------------------: | :---: |
|      Web      |        Backend        |                 Fastify + Node.js                 |   1   |
|               |       Frontend        |                 Tailwind CSS + TS                 |  0.5  |
|               |       Database        |                      SQLite                       |  0.5  |
|               |      Blockchain       |               Avalanche + Solidity                |   1   |
|     Game      |    Remote Players     |                                                   |   1   |
| Cybersecurity |   Secret Management   |         WAF/ModSecurity + HashiCorp Vault         |   1   |
|               |       2FA + JWT       |                                                   |   1   |
|    Devops     |    Log Management     |       ELK (Elasticsearch, Logstash, Kibana)       |   1   |
|   Graphics    |     3D Techniques     |                    Babylon.js                     |   1   |
| Accessiblity  | Browser Compatability |             Firefox Default + Chrome              |  0.5  |
|     Pong      |   Server-side Pong    |                                                   |   1   |
|               |      CLI Client       |                                                   |   1   |
|               |                       |                  ✅ Committed ✅                  | 10.5  |
|     User      |  Standard Management  |           Tedious Albeit Weird Without            |   1   |
|               |                       |             🟡 Partially Committed 🟡             | 11.5  |
|     User      | Remote Authentication | Google Sign-in, Simple But Extra API Key Required |   1   |
|     Game      |     Customization     |                                                   |  0.5  |
|     Algo      |      AI Opponent      |                                                   |   1   |
|     Algo      |    Stats Dashboard    |                                                   |  0.5  |
| Accessibility |   Multiple Language   |                   Ultra-simple                    |  0.5  |
| Accessibility | Server-side Rendering |                   Ultra-simple                    |  0.5  |
| Cybersecurity |    GDPR Compliance    |                                                   |  0.5  |
|    Devops     |   Monitoring System   |               Prometheus + Grafana                |  0.5  |
|               |                       |                ⏳ Total Planned ⏳                | 16.5  |

## License

- [CC0 1.0 Universal](LICENSE)
